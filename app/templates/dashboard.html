<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dash.css') }}">
</head>

<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Invoice Dashboard</h1>

        <!-- Highlights Section -->
        <div class="row text-center">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total Invoices</h5>
                        <p class="card-text" id="total-invoices">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Unique Sellers</h5>
                        <p class="card-text" id="unique-sellers">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Unique Customers</h5>
                        <p class="card-text" id="unique-customers">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Unique Products</h5>
                        <p class="card-text" id="unique-products">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-flex">
            <div class="chart-container">
                <canvas id="top-sellers-chart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="invoices-over-time-chart"></canvas>
            </div>
        </div>

        <!-- Filters and Search Section -->
        <div class="search-bar">
            <input type="text" id="search-box" class="form-control"
                placeholder="Search by Name, NTN, Serial Number, etc.">
        </div>
        <div class="date-filters">
            <input type="date" id="start-date" class="form-control">
            <input type="date" id="end-date" class="form-control">
            <button id="filter-date" class="btn">Filter</button>
        </div>

        <!-- Table Section -->
        <div class="table-responsive">
            <table class="table table-hover table-dark">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Serial Number</th>
                        <th onclick="sortTable(1)">Business Name</th>
                        <th onclick="sortTable(2)">Seller Name</th>
                        <th onclick="sortTable(3)">Address</th>
                        <th onclick="sortTable(4)">Customer Name</th>
                        <th onclick="sortTable(5)">Date</th>
                        <th>Products</th>
                    </tr>
                </thead>
                <tbody id="invoice-table">
                    {% for invoice in invoices %}
                    <tr onclick="openModal(this)" data-id="{{ invoice.id }}"
                        data-customer-receipt-no="{{ invoice.customer_receipt_no }}"
                        data-business-name="{{ invoice.business_name }}" data-name="{{ invoice.name }}"
                        data-address="{{ invoice.address }}" data-customer-name="{{ invoice.customer_name }}"
                        data-date="{{ invoice.date }}" data-products="{{ invoice.products | tojson | safe }}">
                        <td>{{ invoice.customer_receipt_no }}</td>
                        <td>{{ invoice.business_name }}</td>
                        <td>{{ invoice.name }}</td>
                        <td>{{ invoice.address }}</td>
                        <td>{{ invoice.customer_name }}</td>
                        <td>{{ invoice.date }}</td>
                        <td>
                            {% for product in invoice.products %}
                            {{ product.product_name }} x {{ product.quantity }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link"
                        href="{{ url_for('dashboard.dashboard', page=pagination.prev_num, per_page=pagination.per_page) }}"
                        aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}

                {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('dashboard.dashboard', page=page_num, per_page=pagination.per_page) }}">{{
                        page_num }}</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#">...</a>
                </li>
                {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link"
                        href="{{ url_for('dashboard.dashboard', page=pagination.next_num, per_page=pagination.per_page) }}"
                        aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>

        <!-- Modal -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Receipt Details</h2>
                <div id="modal-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Pass the invoices data from Flask to JavaScript
        const invoices = {{ invoices | tojson | safe }};

        // Populate highlights
        document.getElementById('total-invoices').innerText = invoices.length;
        document.getElementById('unique-sellers').innerText = new Set(invoices.map(inv => inv.name)).size;
        document.getElementById('unique-customers').innerText = new Set(invoices.map(inv => inv.customer_name)).size;
        document.getElementById('unique-products').innerText = new Set(invoices.flatMap(inv => inv.products.map(p => p.product_name))).size;

        function openModal(row) {
            // Get the invoice data from the row's data attributes
            const invoice = {
                id: row.getAttribute('data-id'),
                customer_receipt_no: row.getAttribute('data-customer-receipt-no'),
                business_name: row.getAttribute('data-business-name'),
                name: row.getAttribute('data-name'),
                address: row.getAttribute('data-address'),
                customer_name: row.getAttribute('data-customer-name'),
                date: row.getAttribute('data-date'),
                products: JSON.parse(row.getAttribute('data-products'))
            };

            // Build the modal content
            const modalContent = `
        <p><strong>Serial Number:</strong> ${invoice.customer_receipt_no}</p>
        <p><strong>Business Name:</strong> ${invoice.business_name}</p>
        <p><strong>Seller Name:</strong> ${invoice.name}</p>
        <p><strong>Address:</strong> ${invoice.address}</p>
        <p><strong>Customer Name:</strong> ${invoice.customer_name}</p>
        <p><strong>Date:</strong> ${invoice.date}</p>
        <h3>Products</h3>
        <table class="product-table">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Total Price</th>
                </tr>
            </thead>
            <tbody>
                ${invoice.products.map(product => `
                    <tr>
                        <td>${product.product_name}</td>
                        <td>${product.quantity}</td>
                        <td>${product.quantity * product.rate}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

            // Display the modal
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Close the modal if the user clicks outside of it
        window.onclick = function (event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
        // Search functionality
        document.getElementById('search-box').addEventListener('input', function () {
            const searchValue = this.value.toLowerCase();
            const rows = document.querySelectorAll('#invoice-table tr');
            rows.forEach(row => {
                const rowText = row.innerText.toLowerCase();
                row.style.display = rowText.includes(searchValue) ? "" : "none";
            });
        });

        // Sorting functionality
        function sortTable(columnIndex) {
            const tableBody = document.getElementById('invoice-table');
            const rows = Array.from(tableBody.children);
            rows.sort((a, b) => a.children[columnIndex].innerText.localeCompare(b.children[columnIndex].innerText));
            rows.forEach(row => tableBody.appendChild(row));
        }

        // Filter by date
        document.getElementById('filter-date').addEventListener('click', function () {
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            const rows = document.querySelectorAll('#invoice-table tr');
            rows.forEach(row => {
                const rowDate = new Date(row.children[5].innerText);
                row.style.display = rowDate >= startDate && rowDate <= endDate ? "" : "none";
            });
        });

        // Function to create the Top Sellers Chart
        function createTopSellersChart() {
            // Group invoices by seller and count the number of invoices per seller
            const sellerCounts = {};
            invoices.forEach(invoice => {
                const seller = invoice.name;
                sellerCounts[seller] = (sellerCounts[seller] || 0) + 1;
            });

            // Sort sellers by invoice count and get the top 10
            const sortedSellers = Object.entries(sellerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const labels = sortedSellers.map(seller => seller[0]);
            const data = sortedSellers.map(seller => seller[1]);

            new Chart(document.getElementById('top-sellers-chart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Invoices',
                        data: data,
                        backgroundColor: '#61dafb'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Function to create the Invoices Over Time Chart
        function createInvoicesOverTimeChart() {
            // Group invoices by date and count the number of invoices per date
            const dateCounts = {};
            invoices.forEach(invoice => {
                const date = invoice.date;
                dateCounts[date] = (dateCounts[date] || 0) + 1;
            });

            // Sort dates in ascending order
            const sortedDates = Object.entries(dateCounts).sort((a, b) => new Date(a[0]) - new Date(b[0]));

            const labels = sortedDates.map(entry => entry[0]);
            const data = sortedDates.map(entry => entry[1]);

            new Chart(document.getElementById('invoices-over-time-chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Invoices',
                        data: data,
                        borderColor: '#4CAF50',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Create charts on page load
        createTopSellersChart();
        createInvoicesOverTimeChart();
    </script>
</body>

</html>